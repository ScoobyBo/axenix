#!/bin/bash


DB_USER="{{ postgres_admin_user }}"
DB_PASSWORD="{{ postgres_admin_password }}"
DB_NAME="{{ db_name }}"
BACKUP_DIR="{{ backup_dir }}"
MAX_BACKUPS={{ max_backup }}

mkdir -p "$BACKUP_DIR" 2>/dev/null

export PGPASSWORD="$DB_PASSWORD"

pg_dump -U "$DB_USER" "$DB_NAME" 2>/dev/null | \
    gzip > "$BACKUP_DIR/${DB_NAME}_$(date +%Y%m%d_%H%M%S).sql.gz" 2>/dev/null

find "$BACKUP_DIR" -maxdepth 1 -name "${DB_NAME}_*.sql.gz" 2>/dev/null | \
    sort -r | \
    tail -n +$((MAX_BACKUPS + 1)) | \
    xargs -r rm -f 2>/dev/null