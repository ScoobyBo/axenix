---
- name: Stop PostgreSQL before replication sync
  service:
    name: postgresql
    state: stopped

- name: Remove old data directory before replication
  file:
    path: "{{ data_directory }}"
    state: absent

- name: Create empty data directory
  file:
    path: "{{ data_directory }}"
    state: directory
    owner: postgres
    group: postgres
    mode: "0700"

- name: Perform base backup from primary
  command: >
    pg_basebackup
    -h {{ primary_host }}
    -p {{ primary_port }}
    -U {{ replication_user }}
    -D {{ data_directory }}
    -R
  become_user: postgres
  environment:
    PGPASSWORD: "{{ replication_password }}"

- name: Start PostgreSQL in replica mode
  service:
    name: postgresql
    state: started
    enabled: yes
