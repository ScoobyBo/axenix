pipeline {
    agent { label 'ax 2' }

    parameters {
        choice(
            name: 'ROLE',
            choices: [
                'postgre_backup'
            ],
            description: 'Select Ansible role'
        )
    }

    stages {
        stage('Input Role Variables') {
            steps {
                script {
                    switch(ROLE) {

                        case 'postgre_backup':
                            PARAMS = input(
                                message: 'Parameters for postgre_backup',
                                parameters: [
                                    string(name: 'backup_dir', defaultValue: '/opt/postgres_backups'),
                                    string(name: 'max_backups', defaultValue: '30'),
                                    string(name: 'cron_hour', defaultValue: '3'),
                                    string(name: 'cron_minute', defaultValue: '0'),
                                    string(name: 'pg_superuser', defaultValue: 'postgres'),
                                    string(name: 'pg_dumpall_path', defaultValue: '/usr/bin/pg_dumpall')
                                ]
                            )
                            break
                    }
                }
            }
        }

        stage('Run Ansible Role') {
            steps {
                script {
                    ansiblePlaybook(
                        playbook: "postgre_backup.yml",
                        inventory: "inventary.yml",
                        extraVars: PARAMS,
                        colorized: true
                    )
                }
            }
        }
    }
}
