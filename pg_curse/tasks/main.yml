#SPDX-License-Identifier: MIT-0
---
- name: add pg apt repo
  ansible.builtin.deb822_repository:
    name: postgresql
    types: [deb]
    uris: "http://apt.postgresql.org/pub/repos/apt"
    suites: ["{{ ansible_distribution_release }}-pgdg"]
    components: ["main"]
    signed_by: "https://www.postgresql.org/media/keys/ACCC4CF8.asc"
    state: present

- name: install postgres
  ansible.builtin.apt:
    name: "postgresql-{{ postgres_version }}"
    state: present
    update_cache: yes

- name: configure remote access
  ansible.builtin.template:
    src: postgresql.conf
    dest: "/etc/postgresql/{{ postgres_version }}/main/postgresql.conf"
    owner: postgres
    group: postgres
    mode: 0644

- name: configure pg_hba.conf remote connect
  ansible.builtin.template:
    src: pg_hba.conf
    dest: "/etc/postgresql/{{ postgres_version }}/main/pg_hba.conf"
    owner: postgres
    group: postgres
    mode: 0640

- name: restart postgre
  ansible.builtin.service:
    name: "postgresql"
    state: restarted
    enabled: yes

- name: create backup directory
  ansible.builtin.file:
    path: "{{ backup_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: 0750

- name: deploy full backup script
  ansible.builtin.template:
    src: backup_full.sh
    dest: /usr/local/bin/pg_backup_full.sh
    owner: postgres
    group: postgres
    mode: 0750

- name: deploy incremental backup script
  ansible.builtin.template:
    src: backup_incremental.sh
    dest: /usr/local/bin/pg_backup_incremental.sh
    owner: postgres
    group: postgres
    mode: 0750

- name: deploy restore script
  ansible.builtin.template:
    src: restore_db.sh
    dest: /usr/local/bin/pg_restore_latest.sh
    owner: postgres
    group: postgres
    mode: 0750

- name: add cron job for full backup
  ansible.builtin.cron:
    name: "PostgreSQL Full Backup"
    user: postgres
    job: "/usr/local/bin/pg_backup_full.sh"
    hour: "2"
    minute: "0"

- name: add cron job for incremental backup
  ansible.builtin.cron:
    name: "PostgreSQL Incremental Backup"
    user: postgres
    job: "/usr/local/bin/pg_backup_incremental.sh"
    minute: "0"

