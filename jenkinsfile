pipeline {
    agent any

    stages {

        stage('Выбор роли') {
            steps {
                script {
                    ROLE = input(
                        message: 'Какую роль выполнить?',
                        parameters: [
                            choice(
                                name: 'ROLE_NAME',
                                choices: [
                                    'postgre_install',
                                    'postgre_db',
                                    'postgre_users',
                                    'postgre_backup',
                                    'postgre_remote',
                                    'postgre_restore'
                                ].join('\n')
                                description: 'Выберите роль'
                            )
                        ]
                    )
                }
            }
        }

        stage('Сбор переменных роли') {
            steps {
                script {

                    // --- Переменные под конкретные роли ---
                    switch (ROLE["ROLE_NAME"]) {

                        case "install_postgres":
                            params_map = [
                                postgresql_version: input(
                                    message: "Версия PostgreSQL:",
                                    parameters: [
                                        string(name: 'postgresql_version', defaultValue: '15')
                                    ]
                                )
                            ]
                            break

                        case "init_database":
                            params_map = input(
                                message: "Параметры роли init_database",
                                parameters: [
                                    string(name: 'db_name', defaultValue: 'mydb'),
                                    string(name: 'db_owner', defaultValue: 'myuser'),
                                    string(name: 'postgresql_port', defaultValue: '5432')
                                ]
                            )
                            break

                        case "create_users":
                            params_map = input(
                                message: "Список пользователей для создания",
                                parameters: [
                                    text(name: 'postgresql_users',
                                         defaultValue: '''[
  {"name": "appuser", "password": "secret"},
  {"name": "report", "password": "rep_pass"}
]'''
                                    )
                                ]
                            )
                            break

                        case "setup_backups":
                            params_map = input(
                                message: "Параметры бэкапов",
                                parameters: [
                                    string(name: 'backup_dir', defaultValue: '/opt/postgres_backups'),
                                    string(name: 'max_backups', defaultValue: '30'),
                                    string(name: 'full_backup_script', defaultValue: 'full_backup.sh'),
                                    string(name: 'inc_backup_script', defaultValue: 'inc_backup.sh')
                                ]
                            )
                            break

                        case "cluster_setup":
                            params_map = input(
                                message: "Параметры настройки кластера",
                                parameters: [
                                    choice(name: 'postgresql_mode', choices: ['init', 'join']),
                                    string(name: 'postgresql_version', defaultValue: '15'),
                                    string(name: 'data_directory', defaultValue: '/var/lib/postgresql/15/main'),
                                    string(name: 'primary_host', defaultValue: '10.10.10.10'),
                                    string(name: 'primary_port', defaultValue: '5432'),
                                    string(name: 'replication_user', defaultValue: 'replicator'),
                                    password(name: 'replication_password'),
                                    text(name: 'pg_hba_rules',
                                         defaultValue: '''[
"host all all 0.0.0.0/0 md5",
"host replication replicator 10.0.0.0/24 md5"
]'''
                                    )
                                ]
                            )
                            break

                        case "restore_backup":
                            params_map = input(
                                message: "Данные для восстановления",
                                parameters: [
                                    file(name: 'backup_file'),
                                    string(name: 'data_directory', defaultValue: '/var/lib/postgresql/15/main'),
                                    string(name: 'postgresql_version', defaultValue: '15'),
                                    booleanParam(name: 'force_reinit', defaultValue: false)
                                ]
                            )
                            break
                    }
                }
            }
        }

        stage('Выполнение роли') {
            steps {
                ansiblePlaybook(
                    playbook: "site.yml",
                    inventory: "inventory",
                    extraVars: params_map,
                    tags: ROLE["ROLE_NAME"]
                )
            }
        }
    }
}
