pipeline {
    agent { label 'ax 2' }

    parameters {
        choice(
            name: 'ROLE',
            choices: [
                'postgre_install',
                'postgre_remote',
                'postgre_backup',
                'postgre_db',
                'postgre_restore',
                'postgre_users'
            ],
            description: 'Select Ansible role'
        )
    }

    stages {
        stage('Input Role Variables') {
            steps {
                script {
                    switch(ROLE) {

                        case 'postgre_install':
                            PARAMS = input(
                                message: 'Parameters for postgre_install',
                                parameters: [
                                    string(name: 'postgresql_version', defaultValue: '15'),
                                    string(name: 'replication_user', defaultValue: 'replicator'),
                                    password(name: 'replication_password'),
                                    string(name: 'replication_network', defaultValue: '10.0.0.0/24')
                                ]
                            )
                            break

                        case 'postgre_remote':
                            PARAMS = input(
                                message: 'Parameters for postgre_remote',
                                parameters: [
                                    string(name: 'postgresql_version', defaultValue: '15'),
                                    string(name: 'data_directory', defaultValue: '/etc/postgresql/15/main'),
                                    string(name: 'primary_host', defaultValue: '10.10.10.10'),
                                    string(name: 'primary_port', defaultValue: '5432'),
                                    string(name: 'replication_user', defaultValue: 'replicator'),
                                    password(name: 'replication_password'),
                                    text(name: 'pg_hba_rules', defaultValue: "host all all 0.0.0.0/0 md5\nhost replication replicator 10.0.0.0/24 md5")
                                ]
                            )
                            break

                        case 'postgre_backup':
                            PARAMS = input(
                                message: 'Parameters for postgre_backup',
                                parameters: [
                                    string(name: 'backup_dir', defaultValue: '/opt/postgres_backups'),
                                    string(name: 'max_backups', defaultValue: '30')
                                ]
                            )
                            break

                        case 'postgre_db':
                            PARAMS = input(
                                message: 'Parameters for postgre_db',
                                parameters: [
                                    string(name: 'db_name', defaultValue: 'mydb'),
                                    string(name: 'db_owner', defaultValue: 'myuser'),
                                    string(name: 'postgresql_port', defaultValue: '5432')
                                ]
                            )
                            break

                        case 'postgre_restore':
                            PARAMS = input(
                                message: 'Parameters for postgre_restore',
                                parameters: [
                                    string(name: 'backup_file', defaultValue: '/tmp/full_backup.sql.gz'),
                                    string(name: 'data_directory', defaultValue: '/var/lib/postgresql/15/main'),
                                    string(name: 'postgresql_version', defaultValue: '15'),
                                    string(name: 'restore_db', defaultValue: 'gitea'),
                                    booleanParam(name: 'force_reinit', defaultValue: false)
                                ]
                            )
                            break

                        case 'postgre_users':
                            PARAMS = input(
                                message: 'Parameters for postgre_users',
                                parameters: [
                                    string(name: 'postgresql_user_name', defaultValue: 'appuser'),
                                    password(name: 'postgresql_user_password', defaultValue: 'secret123')
                                ]
                            )
                            break
                    }
                }
            }
        }

        stage('Run Ansible Role') {
            steps {
                script {
                    ansiblePlaybook(
                        playbook: "${ROLE}.yml",
                        inventory: "inventary.yml",
                        extraVars: PARAMS,
                        colorized: true
                    )
                }
            }
        }
    }
}