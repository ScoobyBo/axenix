def params_map = [:]
def ROLE = ""

pipeline {
    agent any

    stages {

        stage('Выбор роли') {
            steps {
                script {
                    ROLE = input(
                        message: 'Какую роль выполнить?',
                        parameters: [
                            choice(
                                name: 'ROLE_NAME',
                                choices: [
                                    'postgre_install',
                                    'postgre_db',  
                                    'postgre_users',
                                    'postgre_backup',
                                    'postgre_remote',
                                    'postgre_restore'
                                ].join('\n')
                            )
                        ]
                    )
                }
            }
        }

        stage('Сбор переменных роли') {
            steps {
                script {
                    switch (ROLE["ROLE_NAME"]) {

                        case "postgre_install":
                            params_map = input(
                                message: "Параметры установки PostgreSQL:",
                                parameters: [
                                    string(name: 'postgresql_version', defaultValue: '15')
                                ]
                            )
                            break

                        case "postgre_db":
                            params_map = input(
                                message: "Настройка DB:",
                                parameters: [
                                    string(name: 'db_name', defaultValue: 'mydb'),
                                    string(name: 'db_owner', defaultValue: 'myuser')
                                ]
                            )
                            break

                        case "postgre_users":
                            params_map = input(
                                message: "Пользователи:",
                                parameters: [
                                    text(name: 'postgresql_users',
                                         defaultValue: '''[
  {"name": "appuser", "password": "secret"},
  {"name": "report", "password": "rep_pass"}
]'''
                                    )
                                ]
                            )
                            break

                        case "postgre_backup":
                            params_map = input(
                                message: "Параметры backup:",
                                parameters: [
                                    string(name: 'backup_dir', defaultValue: '/opt/postgres_backups'),
                                    string(name: 'max_backups', defaultValue: '30')
                                ]
                            )
                            break

                        case "postgre_restore":
                            params_map = input(
                                message: "Параметры восстановления:",
                                parameters: [
                                    file(name: 'backup_file'),
                                    string(name: 'data_directory', defaultValue: '/var/lib/postgresql/15/main')
                                ]
                            )
                            break
                    }
                }
            }
        }

        stage('Выполнение роли') {
            steps {
                ansiblePlaybook(
                    playbook: "site.yml",
                    inventory: "inventory",
                    extraVars: params_map,
                    tags: ROLE["ROLE_NAME"]
                )
            }
        }
    }
}
